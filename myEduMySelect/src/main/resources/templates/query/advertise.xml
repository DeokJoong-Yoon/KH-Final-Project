<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myedumyselect.commonboard.advertise.dao.AdvertiseDAO">
	
	<!-- AdvertiseVO 별칭 일괄 부여 -->
	<resultMap type="advertiseBoard" id="advertiseBoardMap">
		<id column="common_no" property="commonNo" />
		<result column="academy_id" property="academyId" />
		<result column="member_type_id" property="memberTypeId" />
		<result column="common_nickname" property="commonNickname" />
		<result column="common_title" property="commonTitle" />
		<result column="common_content" property="commonContent" />
		<result column="common_register_date" property="commonRegisterDate" />
		<result column="common_edit" property="commonEdit" />
		<result column="common_readcnt" property="commonReadcnt" />
		<result column="common_block_confirm" property="commonBlockConfirm" />
		<result column="common_block_date" property="commonBlockDate" />
		<result column="common_thumb" property="commonThumb" />
	</resultMap>
	
	
	<!-- FileVO 별칭 일괄 부여 -->
	<resultMap type="file" id="fileMap">
		<id column="common_no" property="commonNo" />
		<result column="file_no" property="fileNo" />
		<result column="file_path" property="filePath" />
		<result column="file_name" property="fileName" />
	</resultMap>
	
	
	
	
	<!-- 전체 레코드 수 조회 -->
	<select id="advertiseListCnt" parameterType="advertiseBoard" resultType="int">
		<![CDATA[
		SELECT 	count(*) FROM tb_common_board
		WHERE	common_no >= 20000 AND common_no < 30000
		AND		( 	( common_nickname LIKE '%' || #{keyword} || '%' )
					OR  ( common_title LIKE '%' || #{keyword} || '%' )
					OR  ( common_content LIKE '%' || #{keyword} || '%' )
				)
		]]>
	</select>
	
	
	<!-- 홍보게시판 글 목록 조회 + 검색 포함 -->
	<select id="advertiseList" parameterType="advertiseBoard" resultMap="advertiseBoardMap">
		<![CDATA[
		SELECT 	common_no
		, 		academy_id
		, 		member_type_id
		, 		common_nickname
		, 		common_title
		, 		to_char(common_register_date,'YYYY-MM-DD') as common_register_date
		, 		common_readcnt
		,		common_block_confirm
		,		common_thumb
		,		commonCommentCnt
		FROM 	(
				SELECT /*+ INDEX_DESC(tb_common_board PK_TB_COMMON_BOARD) */
						rownum as rnum
				,		common_no
				,		academy_id
				,		member_type_id
				,		common_nickname
				,		common_title
				,		common_register_date
				,		common_readcnt
				,		common_block_confirm
				,		common_thumb
				,		( SELECT COUNT(common_comment_no) 
	            		  FROM tb_common_comment 
	            		  WHERE common_no = tb_common_board.common_no)   as commonCommentCnt
	            FROM	tb_common_board
	            WHERE	rownum <= #{pageNum} * #{amount}
	            AND		common_no >= 20000 AND common_no < 30000
	            AND		( 	( common_nickname LIKE '%' || #{keyword} || '%' )
							OR  ( common_title LIKE '%' || #{keyword} || '%' )
							OR  ( common_content LIKE '%' || #{keyword} || '%' )
						)
				)
		WHERE rnum > (#{pageNum} - 1 ) * #{amount}
		]]>
	</select>
	
	
	<!-- 홍보게시판 글 등록 (only 글) -->
	<!-- <insert id="advertiseInsert" parameterType="advertiseBoard" useGeneratedKeys="true" keyProperty="id">
	    INSERT 
	    INTO 	tb_common_board (
					    			common_no
					    		,	academy_id
					    		, 	member_type_id
					    		, 	common_nickname
					    		, 	common_title
					    		, 	common_content
					    		, 	common_register_date
					    		, 	common_thumb
				)
	    VALUES	(
			    	advertise_board_seq.nextval
			    , 	#{academyId}
			    , 	2
			    , 	#{commonNickname} 
			    ,	#{commonTitle}
			    ,	#{commonContent}
			    ,	sysdate
			    ,	#{commonThumb}
		)
		RETURNING common_no INTO #{commonNo}
	</insert> -->
	
	<insert id="advertiseInsert" parameterType="advertiseBoard" useGeneratedKeys="true" keyProperty="id">
	    <![CDATA[
	    INSERT INTO tb_common_board (
	        common_no,
	        academy_id,
	        member_type_id,
	        common_nickname,
	        common_title,
	        common_content,
	        common_register_date,
	        common_thumb
	    )
	    VALUES (
	        advertise_board_seq.nextval,
	        #{academyId},
	        2,
	        #{commonNickname},
	        #{commonTitle},
	        #{commonContent},
	        sysdate,
	        #{commonThumb}
	    )
	    ]]>
	    <selectKey keyProperty="commonNo" resultType="int" order="AFTER">
	        SELECT advertise_board_seq.currval AS id FROM DUAL
	    </selectKey>
	</insert>
	
	
	<!-- 홍보게시판 게시글 내 첨부파일 등록 -->
	<insert id="advertiseInsertFile" parameterType="file">
	    INSERT 
	    INTO 	tb_file 
	    VALUES 	(
	    			#{commonNo}
	    		, 	notice_board_file_seq.nextval 
	    		,	#{fileName}
	    		, 	#{filePath}
	    		)
	</insert>
	
	
</mapper>